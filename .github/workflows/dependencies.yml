name: AtualizaÃ§Ã£o de DependÃªncias

on:
  schedule:
    # Executa semanalmente Ã s segundas-feiras Ã s 7:00
    - cron: '0 7 * * 1'
  
  # Permite execuÃ§Ã£o manual do workflow
  workflow_dispatch:
    inputs:
      dependency-type:
        description: 'Tipo de dependÃªncia a atualizar'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - prod
          - dev
          - vuln

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: Configurar Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      
      # Verificar se hÃ¡ vulnerabilidades de seguranÃ§a nas dependÃªncias
      - name: Verificar vulnerabilidades
        id: audit
        continue-on-error: true
        run: |
          npm audit --json > audit-report.json || echo "Vulnerabilidades encontradas"
          if [ -s audit-report.json ]; then
            echo "has_vulns=true" >> $GITHUB_OUTPUT
          else
            echo "has_vulns=false" >> $GITHUB_OUTPUT
          fi
      
      # Preparar outputs para o job
      - name: Inicializar variÃ¡veis
        id: init
        run: |
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "branch_name=dependabot/npm_updates-$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
          
      # Executar atualizaÃ§Ã£o de dependÃªncias com vulnerabilidades
      - name: Atualizar dependÃªncias com vulnerabilidades
        id: vuln_update
        if: ${{ inputs.dependency-type == 'vuln' || inputs.dependency-type == 'all' || steps.audit.outputs.has_vulns == 'true' }}
        run: |
          # Criar uma nova branch para as atualizaÃ§Ãµes
          BRANCH_NAME="dependabot/npm_security_updates-$(date +'%Y%m%d')"
          git checkout -b $BRANCH_NAME
          
          # Executar npm audit fix
          if npm audit fix --force; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          else
            echo "Falha ao corrigir todas as vulnerabilidades automaticamente"
          fi
      
      # Atualizar dependÃªncias de produÃ§Ã£o
      - name: Atualizar dependÃªncias de produÃ§Ã£o
        id: prod_update
        if: ${{ inputs.dependency-type == 'prod' || inputs.dependency-type == 'all' }}
        run: |
          # Criar uma nova branch para as atualizaÃ§Ãµes (se ainda nÃ£o existir)
          if [ "${{ steps.vuln_update.outputs.has_changes }}" != "true" ]; then
            BRANCH_NAME="${{ steps.init.outputs.branch_name }}"
            git checkout -b $BRANCH_NAME
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          else
            BRANCH_NAME="${{ steps.vuln_update.outputs.branch_name }}"
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          fi
          
          # Atualizar dependÃªncias de produÃ§Ã£o
          if npx npm-check-updates -u --dep prod --target minor; then
            npm install
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      # Atualizar dependÃªncias de desenvolvimento
      - name: Atualizar dependÃªncias de desenvolvimento
        id: dev_update
        if: ${{ inputs.dependency-type == 'dev' || inputs.dependency-type == 'all' }}
        run: |
          # Usar a branch jÃ¡ criada ou criar uma nova
          if [ "${{ steps.vuln_update.outputs.has_changes }}" == "true" ]; then
            BRANCH_NAME="${{ steps.vuln_update.outputs.branch_name }}"
          elif [ "${{ steps.prod_update.outputs.has_changes }}" == "true" ]; then
            BRANCH_NAME="${{ steps.prod_update.outputs.branch_name }}"
          else
            BRANCH_NAME="${{ steps.init.outputs.branch_name }}"
            git checkout -b $BRANCH_NAME
          fi
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Atualizar dependÃªncias de desenvolvimento
          if npx npm-check-updates -u --dep dev --target minor; then
            npm install
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      # Determinar se houve alguma mudanÃ§a
      - name: Verificar se houve mudanÃ§as
        id: check_changes
        run: |
          if [ "${{ steps.vuln_update.outputs.has_changes }}" == "true" ] || [ "${{ steps.prod_update.outputs.has_changes }}" == "true" ] || [ "${{ steps.dev_update.outputs.has_changes }}" == "true" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            if [ "${{ steps.vuln_update.outputs.branch_name }}" != "" ]; then
              echo "branch_name=${{ steps.vuln_update.outputs.branch_name }}" >> $GITHUB_OUTPUT
            elif [ "${{ steps.prod_update.outputs.branch_name }}" != "" ]; then
              echo "branch_name=${{ steps.prod_update.outputs.branch_name }}" >> $GITHUB_OUTPUT
            elif [ "${{ steps.dev_update.outputs.branch_name }}" != "" ]; then
              echo "branch_name=${{ steps.dev_update.outputs.branch_name }}" >> $GITHUB_OUTPUT
            else
              echo "branch_name=${{ steps.init.outputs.branch_name }}" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      # Verificar se hÃ¡ mudanÃ§as e fazer commit
      - name: Commit das mudanÃ§as
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add package.json package-lock.json
          git commit -m "build: atualiza dependÃªncias do projeto" -m "AtualizaÃ§Ã£o automÃ¡tica de dependÃªncias pelo GitHub Actions"
      
      # Executar os testes para garantir que as atualizaÃ§Ãµes nÃ£o quebrem nada
      - name: Executar testes
        if: steps.check_changes.outputs.has_changes == 'true'
        id: test
        continue-on-error: true
        run: |
          npm run lint
          npm run test:ci
          npm run build
          if [ $? -eq 0 ]; then
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=false" >> $GITHUB_OUTPUT
          fi
      
      # Criar Pull Request com as mudanÃ§as
      - name: Criar Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "build: atualiza dependÃªncias do projeto"
          branch: ${{ steps.check_changes.outputs.branch_name }}
          delete-branch: true
          title: "build: atualiza dependÃªncias do projeto"
          body: |
            ## ğŸ¤– AtualizaÃ§Ã£o automÃ¡tica de dependÃªncias
            
            Este PR foi gerado automaticamente pelo workflow de atualizaÃ§Ã£o de dependÃªncias.
            
            ### ğŸ“‹ AlteraÃ§Ãµes:
            
            ${{ steps.test.outcome == 'success' && 'âœ… Todos os testes passaram com as novas dependÃªncias.' || 'âš ï¸ Os testes falharam com as novas dependÃªncias. Por favor, verifique antes de fazer merge.' }}
            ${{ steps.audit.outputs.has_vulns == 'true' && 'ğŸ›¡ï¸ Este PR inclui correÃ§Ãµes para vulnerabilidades de seguranÃ§a.' || '' }}
            
            <details>
              <summary>ğŸ“¦ Lista de dependÃªncias atualizadas</summary>
            
              ```
              $(git diff --unified=0 package.json | grep "^[+-]" | grep -v "^ [+-]" | grep -v "version\|name\|description")
              ```
            </details>
            
            ### âš™ï¸ PrÃ³ximos passos:
            
            1. Revise as mudanÃ§as
            2. Verifique se todos os testes estÃ£o passando
            3. FaÃ§a merge do PR para aplicar as atualizaÃ§Ãµes
          labels: |
            dependencies
            automated-pr
          assignees: ${{ github.repository_owner }}
          reviewers: ${{ github.repository_owner }}
      
      # Notificar sobre problemas nos testes
      - name: Notificar sobre falhas nos testes
        if: steps.check_changes.outputs.has_changes == 'true' && steps.test.outputs.tests_passed == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ **AtenÃ§Ã£o**: Os testes falharam apÃ³s atualizar as dependÃªncias. RevisÃ£o manual necessÃ¡ria antes do merge.'
            })
